# TODOï¼šã€€Actionsæ¨©é™ä»˜ä¸ã—ã¦ã‚‚ã‚‰ãˆãŸã‚‰æœ‰åŠ¹åŒ–ã§ãã‚‹ã‹ã‚‚
name: Sync main to upstream

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Create PR to upstream if not exists
        uses: actions/github-script@v6
        with:
          # TODO:upstreamã®PRä½œæˆç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šã™ã‚‹
          github-token: ${{ secrets.UPSTREAM_PR_TOKEN }}
          script: |
            const owner = "moooda-dev";
            const repo = "zenn-contents";
            const base = "main";
            const head = "en-tomoda:main";

            // æ—¢å­˜PRãƒã‚§ãƒƒã‚¯
            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              base,
              head,
            });

            if (pulls.length > 0) {
              console.log("PR already exists. Skip.");
              return;
            }

            // æ—¥ä»˜ï¼ˆJSTï¼‰
            const now = new Date(Date.now() + 9 * 60 * 60 * 1000);
            const date = now.toISOString().slice(0, 10);

            // å·®åˆ†å–å¾—
            const { data: compare } = await github.rest.repos.compareCommits({
              owner,
              repo,
              base,
              head,
            });

            // articles é…ä¸‹ã®ã¿
            const articleFiles = compare.files
              .filter(file => file.filename.startsWith("articles/"))
              .map(file => file.filename);

            const articleList = articleFiles.length
              ? articleFiles.map(f => `- ${f}`).join("\n")
              : "- ï¼ˆè¨˜äº‹ã®å¤‰æ›´ãªã—ï¼‰";

            // PRä½œæˆ
            await github.rest.pulls.create({
              owner,
              repo,
              base,
              head,
              title: `chore: sync articles (${date})`,
              body: `origin(en-tomoda)/main ã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸå†…å®¹ã‚’ upstream ã«åŒæœŸã—ã¾ã™ã€‚

              ## ğŸ“ è¨˜äº‹ä¸€è¦§
              ${articleList}

              ï¼ˆè‡ªå‹•ç”ŸæˆPRï¼‰
              `,
              });

              console.log("PR created to upstream.");
